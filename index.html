<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Watcher</title>
    <style>
      * {
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, Helvetica, Arial, sans-serif;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        display: grid;
        grid-template-rows: 1fr auto;
        height: 100vh;
        max-height: -webkit-fill-available;
        background-color: #0A1929;
        color: white;
      }

      main {
        overflow-y: auto;
      }

      main > .content {
        padding: 20px;
        position: relative;
      }

      main > .content > .list-header {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }

      main > .content .item {
        display: grid;
        grid-gap: 10px;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        margin-bottom: 20px;
      }

      main > .content .item:last-child {
        margin-bottom: 0;
      }

      main > .content .item > img {
        height: 100px;
        max-height: 100px;
        border-radius: 5px;
      }

      main > .content .item > .item-info {
        font-size: 0.9rem;
      }

      main > .content .item > .item-info > div:first-child {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 5px;
      }

      main > .content .item > .item-info > div.item-info-secondary {
        margin-top: 5px;
        color: rgba(255, 255, 255, .4);
      }

      main > .content .item > img.action {
        height: 32px;
        width: 32px;
        cursor: pointer;
        margin-right: 5px;
      }

      main > .content > form {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-gap: 10px;
        margin-bottom: 20px;
      }

      main > .content > form > button {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        cursor: pointer;
        padding: 7px 7px 0 7px;
        border-radius: 5px;
        font-size: 1.2rem;
      }

      main > .content > form > button > img {
        height: 28px;
        width: 28px;
      }

      main > .content > form > input {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 1.2rem;
        min-width: 0;
        line-height: 1.2rem;
      }

      main > .content > #search-container {
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        padding: 80px 20px 20px 20px;
        background-color: rgba(0, 0, 0, 0.9);
        overflow-y: auto;
      }

      main > .content > #search-container > #close-search {
        position: fixed;
        top: 20px;
        right: 20px;
        height: 42px;
        width: 42px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.1);
        padding: 5px;
        border-radius: 5px;
      }

      main > .content > .backup-restore-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 20px;
        text-align: center;
        margin-top: 20px;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.4);
      }

      main > .content > .backup-restore-actions input {
        display: none;
      }

      main > .content > .backup-restore-actions label {
        display: block;
        cursor: pointer;
      }

      footer > nav {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        border-top: solid rgba(255, 255, 255, 0.1) 2px;
      }

      footer > nav > div {
        text-align: center;
        padding: 16px;
        cursor: pointer;
      }

      footer > nav > div.selected {
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="content-shows" class="content">
        <form>
          <input type="text" name="search-input" id="search-input" />
          <button type="submit">
            <img src="./img/search.svg" />
          </button>
        </form>

        <div id="show-list"></div>
        
        <div class="backup-restore-actions">
          <div id="backup">Backup</div>
          <div>
            <label for="restore">Restore</label>
            <input type="file" id="restore" />
          </div>
        </div>

        <div id="search-container">
          <div id="search-results"></div>
          <img src="./img/close.svg" id="close-search" />
        </div>
      </div>
      <div id="content-recent" class="content"></div>
      <div id="content-upcoming" class="content"></div>
    </main>
    <footer>
      <nav>
        <div id="tab-shows">Shows</div>
        <div id="tab-recent">Recent</div>
        <div id="tab-upcoming">Upcoming</div>
      </nav>
    </footer>

    <script src="./lib/dayjs-1.11.7/dayjs.min.js"></script>
    <script src="./lib/dayjs-1.11.7/duration.js"></script>
    <script src="./lib/dayjs-1.11.7/relativeTime.js"></script>
    <script src="./lib/dayjs-1.11.7/advancedFormat.js"></script>

    <script>
      dayjs.extend(window.dayjs_plugin_duration);
      dayjs.extend(window.dayjs_plugin_relativeTime);
      dayjs.extend(window.dayjs_plugin_advancedFormat);

      // content: shows|recent|upcoming
      function navigateTo(content) {
        localStorage.setItem('activeTab', content);

        const links = document.querySelector('nav').children;
        Array.from(links).filter((c) => c.id.includes(content)).map((c) => c.classList.add('selected'));
        Array.from(links).filter((c) => !c.id.includes(content)).map((c) => c.classList.remove('selected'));
        
        const contents = document.querySelector('main').children;
        Array.from(contents).filter((c) => c.id.includes(content)).map((c) => c.style.display = 'block');
        Array.from(contents).filter((c) => !c.id.includes(content)).map((c) => c.style.display = 'none');
      }

      // Init storage
      if (!localStorage.getItem('shows')) {
        localStorage.setItem('shows', JSON.stringify([]));
      }
      
      function getShows() {
        return JSON.parse(localStorage.getItem('shows'));
      }

      async function saveShow(show) {
        if (!getShows().find((s) => s.id === show.id)) {
          const res = await fetch(`https://api.tvmaze.com/shows/${show.id}/episodes`);
          const episodes = await res.json();
          localStorage.setItem('shows', JSON.stringify([...getShows(), { ...show, episodes }]));
        }
      }

      function removeShow(showId) {
        if (getShows().find((s) => s.id === showId)) {
          localStorage.setItem('shows', JSON.stringify(getShows().filter((s) => s.id !== showId)));
        }
      }

      async function fetchShows(searchText) {
        if (searchText) {
          const res = await fetch(`https://api.tvmaze.com/search/shows?q=${searchText}`);
          const json = await res.json();
          return json.map((j) => j.show);
        }
      }

      // action: add|remove
      function createShowElement(show, action) {
        const showImg = document.createElement('img');
        showImg.src = show.image ? show.image.medium : './img/placeholder.svg';

        const showInfo = document.createElement('div');
        showInfo.className = 'item-info';
        
        const showName = document.createElement('div');
        showName.textContent = show.name;

        const showRelease = document.createElement('div');
        showRelease.textContent = show.premiered
          ? show.premiered.slice(0, 4)
          : show.status;

        showInfo.appendChild(showName);
        showInfo.appendChild(showRelease);

        let actionElement = document.createElement('img');
        actionElement.className = 'action';

        if (action === 'add') {
          actionElement.src = './img/add.svg';
          actionElement.addEventListener('click', async () => {
            await saveShow(show);
            renderShows();
            renderEpisodes();
            document.getElementById('close-search').click();
          })
        } else if (action === 'remove') {
          actionElement.src = './img/remove.svg';
          actionElement.addEventListener('click', () => {
            removeShow(show.id);
            renderShows();
            renderEpisodes();
          })
        }

        const showItem = document.createElement('div');
        showItem.className = 'item';
        showItem.appendChild(showImg);
        showItem.appendChild(showInfo);
        showItem.appendChild(actionElement);

        return showItem;
      }

      function renderSearchResults(shows = []) {
        const fragment = document.createDocumentFragment();
        for (const show of shows) {
          fragment.appendChild(createShowElement(show, 'add'));
        }
        searchResults.appendChild(fragment);
        searchContainer.style.display = 'block';
      }

      function renderShows() {
        const showList = document.getElementById('show-list');
        showList.replaceChildren();
        
        const fragment = document.createDocumentFragment();
        const shows = getShows().sort((s1, s2) => s1.name.localeCompare(s2.name));
        for (const show of shows) {
          fragment.appendChild(createShowElement(show, 'remove'));
        }
        showList.appendChild(fragment);
      }

      function renderEpisodes(groupedEpisodes) {
        ['recent', 'upcoming'].forEach((content) => {
          const contentTab = document.getElementById(`content-${content}`);
          contentTab.replaceChildren();
          const fragment = document.createDocumentFragment();

          const sevenDaysFromNow = dayjs(dayjs().format('YYYY-MM-DD')).add(1, 'week');
          const sevenDaysAgo = dayjs(dayjs().format('YYYY-MM-DD')).subtract(1, 'week')

          Object.entries(getGroupedEpisodes(content)).forEach(([date, episodes]) => {
            const airDate = dayjs(date);
            const airDateString =
              content === 'upcoming' && airDate < sevenDaysFromNow ||
              content === 'recent' && airDate > sevenDaysAgo
                ? airDate.format('dddd')
                : airDate.format('dddd, MMMM Do');

            const dateElement = document.createElement('div');
            dateElement.className = 'list-header';
            dateElement.textContent = airDateString;
            fragment.appendChild(dateElement);

            episodes.forEach((episode) => {
              const episodeItem = document.createElement('div');
              episodeItem.className = 'item';

              const showImage = document.createElement('img');
              showImage.src = episode.showImage;

              const episodeInfo = document.createElement('div');
              episodeInfo.className = 'item-info';

              const showName = document.createElement('div');
              showName.textContent = episode.showName;
              const episodeNumber = document.createElement('div');
              episodeNumber.textContent =
                `${episode.episodeNumber}x${episode.episodeSeason.toString().padStart(2, '0')} ${episode.episodeName}`;
              const airTimeDelta = document.createElement('div');
              airTimeDelta.className = 'item-info-secondary'
              airTimeDelta.textContent = dayjs.duration(dayjs(episode.airStamp).diff(dayjs())).humanize(true);

              episodeInfo.appendChild(showName);
              episodeInfo.appendChild(episodeNumber);
              episodeInfo.appendChild(airTimeDelta);

              episodeItem.appendChild(showImage);
              episodeItem.appendChild(episodeInfo);

              fragment.appendChild(episodeItem);
            });
          });

          contentTab.appendChild(fragment);
        });
      }

      // content: recent|upcoming
      function getGroupedEpisodes(content) {
        return getShows().flatMap((s) => {
          return s.episodes.map((e) => ({
            showName: s.name,
            showImage: s.image ? s.image.medium : './img/placeholder.svg',
            airDate: e.airdate,
            airStamp: e.airstamp,
            episodeSeason: e.season,
            episodeNumber: e.number,
            episodeName: e.name,
          }));
        }).filter((e) => {
          if (content === 'recent') {
            return new Date(e.airDate) < new Date();
          } else if (content === 'upcoming') {
            return new Date(e.airDate) > new Date();
          }
          return false;
        }).sort((e1, e2) => {
          if (content === 'recent') {
            return new Date(e2.airDate) - new Date(e1.airDate); 
          }
          return new Date(e1.airDate) - new Date(e2.airDate); 
        }).reduce((group, episode) => {
          const { airDate } = episode;
          group[airDate] = group[airDate] ?? [];
          group[airDate].push(episode);
          return group;
        }, {});
      }

      // Render contents
      renderShows();
      renderEpisodes();

      // Initialize navigation
      navigateTo(localStorage.getItem('activeTab') || 'recent')

      document.getElementById('tab-shows').addEventListener('click', () => navigateTo('shows'));
      document.getElementById('tab-recent').addEventListener('click', () => navigateTo('recent'));
      document.getElementById('tab-upcoming').addEventListener('click', () => navigateTo('upcoming'));

      // Initialize search
      const searchContainer = document.getElementById('search-container');
      const searchResults = document.getElementById('search-results');

      document.getElementById('close-search').addEventListener('click', () => {
        searchContainer.style.display = 'none';
        searchResults.replaceChildren();
      })

      const form = document.querySelector('form')
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const searchInput = formData.get('search-input');
        if (searchInput) {
          document.getElementById('search-input').blur();
          const shows = await fetchShows(searchInput);
          renderSearchResults(shows);
        }
      });

      // Initialize backup/restore
      document.getElementById('backup').addEventListener('click', () => {
        const data = `data:text/json;charset=utf-8,${encodeURIComponent(localStorage.getItem('shows'))}`;
        const download = document.createElement('a');
        download.setAttribute('href',  data);
        download.setAttribute('download', `watcher-backup-${new Date().toISOString()}.json`);
        document.body.appendChild(download);
        download.click();
        document.body.removeChild(download);
      });

      document.getElementById('restore').addEventListener('click', () => {
        const fileSelector = document.getElementById('restore');
        fileSelector.addEventListener('change', (event) => {
          const fileList = event.target.files;
          const file = fileList[0];
          if (file) {
            const reader = new FileReader();
            reader.readAsText(file, 'utf-8');
            reader.onload = function (e) {
              const showsToRestore = JSON.parse(e.target.result);
              showsToRestore.map(saveShow);
              setTimeout(() => {
                renderShows();
                renderEpisodes();
              }, 1000);
            }
          }
        });
      });
    </script>
  </body>
</html>
